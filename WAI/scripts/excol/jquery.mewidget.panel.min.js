/**
 * Simple Panel object for use in the meWidgets
 * 
 * @package meWidgets
 * @author Mandana Eibegger
 *          with support from eGovMon Project and 
 *          W3C/WAI Education and Outreach Working Group (EOWG)
 *          see http://www.schoener.at/mewidgets/ for more information
 * @version v0.9 (17 Feb 2012)
 * 
 * Implements a simple panel consisting of
 *   - head
 *   - body
 *   - tab (element that triggers expand/collapse)
 */
(function(a,b){b=a.fn.panel=function(d){if(a.isFunction(b[d])){var c=Array.prototype.slice.call(arguments,1);return this.each(function(){b[d].apply(a(this),c)})}else{a.error("Method "+d+" does not exist on jQuery.panel");return this}};a.extend(b,{settings:{head:"f_panelHead",expander:"f_expanderWrapper",expandSpeedPrefix:"f_expandSpeed_",collapseSpeedPrefix:"f_collapseSpeed_",slideAnim:false,buttonExpand:"f_expand",buttonCollapse:"f_collapse",buttonSrcHover:"f_srcHover",buttonSrcFocus:"f_srcFocus",buttonSrcDisabled:"f_srcDisabled",moveButtonTitle:false,headIsTab:"f_headIsTab",headIsTabDefault:false,forceTabInHead:false,tabCursor:"pointer",panelStartClosed:"f_startClosed",panelStartOpen:"f_startOpen",panelStartClosedDefault:false,triggerShown:"f_triggerShown",tabHashPrefix:"tab_",state:{disabled:"fs_disabled",hover:"fs_hover",hoverInside:"fs_hoverinside",focus:"fs_focus"},nestedWidget:"f_nestedWidget"},init:function(i,e,q,m){if(m){a.extend(b.settings,m.settings);b=m}if(q){a.extend(b.settings,q)}a("body").data("tabHashPrefix",b.settings.tabHashPrefix);var n=a(this);var l=n.find("."+b.settings.expander).first();var p=(b.settings.headIsTabDefault||e.hasClass(b.settings.headIsTab)||l.hasClass(b.settings.headIsTab)||l.length==0)&&!b.settings.forceTabInHead;var g=(p)?n:l;var k=i.hasClass(b.settings.panelStartOpen)?false:(i.hasClass(b.settings.panelStartClosed)?true:b.settings.panelStartClosedDefault);var f=i.metools("classSetting",b.settings.expandSpeedPrefix);if(f===false){f=e.metools("classSetting",b.settings.expandSpeedPrefix)}if(f===false){f="slow"}else{if(f=="noanim"){f=""}}var j=i.metools("classSetting",b.settings.collapseSpeedPrefix);if(j===false){j=e.metools("classSetting",b.settings.collapseSpeedPrefix)}if(j===false){j="slow"}else{if(j=="noanim"){j=""}}var o=b.hashInPanel(n,i,p);var h=b.getAction(n,i,p);var d={expanded:(!k||o),expandedByHash:o,expandSpeed:f,collapseSpeed:j,slideAnim:b.settings.slideAnim,mouseInside:false,head:n,action:h,body:i,wrapper:e};g.css("cursor",b.settings.tabCursor).bind("click",d,b.click).bind("dblclick",d,b.dblclick).bind("mouseenter",d,b.mouseenter).bind("mouseleave",d,b.mouseleave).bind("mouseinside",d,b.mouseinside).bind("focus",d,b.focus).bind("blur",d,b.blur).bind("expand",d,b.expand).bind("collapse",d,b.collapse).data("tabSettings",d);if(p){b.initElementsInTab(g)}var c=p?i:n.add(i);c.bind("expand",d,b.expand).bind("collapse",d,b.collapse);n.data("panel",{head:n,tab:g,body:i});e.data("panelSettings",a.extend({},b.settings));return n},initElementsInTab:function(c){var d=c.data("tabSettings");b.setTabElementInteraction(c.metools("focusableElements",true),d)},setTabElementInteraction:function(c,d){c.each(function(){var e=a(this);e.bind("blur",d,b.blurInside);if(!e.is("a")||e.attr("href")||e.hasClass(b.settings.nestedWidget)){e.bind("mouseenter",d,b.mouseenterInside).bind("mouseleave",d,b.mouseleaveInside).bind("click",b.stopPropagationForElementsInTab).bind("dblclick",b.stopPropagationForElementsInTab)}else{e.bind("focus",d,b.focus)}})},getAction:function(){},expansionButtonLoaded:function(c){var d=this.hasClass(b.settings.expander)?this:this.find("."+b.settings.expander);d.children().hide();if(!c){b.expansionButtonPrepare.apply(d)}},expansionButtonPrepare:function(){var m=a(this).first();var k=m.parents("."+b.settings.head).first();if(!k.length){k=m.parent()}var h=k.data("panel").body;var g=k.add(h);var l=m.find("."+b.settings.buttonExpand).metools("replaceContentVars",g);var j=l.find("."+b.settings.buttonSrcHover).attr("title");var d=l.find("."+b.settings.buttonSrcFocus).attr("title");var f=m.find("."+b.settings.buttonCollapse).metools("replaceContentVars",g);var e=f.find("."+b.settings.buttonSrcHover).attr("title");var i=f.find("."+b.settings.buttonSrcFocus).attr("title");m.find("."+b.settings.buttonSrcHover).remove().end().find("."+b.settings.buttonSrcFocus).remove().end().children().show();var c=a.extend(k.data("panel").tab.data("tabSettings"),{buttonExpand:l,buttonCollapse:f,buttonExpandSrc:l.find("img").attr("src"),buttonExpandSrcHover:j,buttonExpandSrcFocus:d,buttonCollapseSrc:f.find("img").attr("src"),buttonCollapseSrcHover:e,buttonCollapseSrcFocus:i});l.add(f).bind("focus",c,b.focusButton).bind("blur",c,b.blurButton);b.initPanel(c)},initPanel:function(d){var c=a.extend({},d,{initOnly:true});if(d.expanded){b.expand(c)}else{b.collapse(c)}},click:function(c){b.handleExpandStateChange(c)},dblclick:function(){},handleExpandStateChange:function(c){if(c.data.expanded){b.collapse(c.data)}else{b.expand(c.data);b.hashControl(c)}if(typeof(c.preventBubble)=="function"){c.preventBubble();c.stopPropagation()}c.preventDefault()},hashControl:function(d){var c=a(d.target).attr("href");if(c!=undefined){if(c[0]=="#"){var e=c.substr(1);if(window.location.hash!=c){if(typeof(hashcontrol)!="undefined"&&hashcontrol){a(c).attr("id",b.settings.tabHashPrefix+e)}window.location.hash=c}}}},expand:function(c,f,e){if(c.data!=undefined){c=c.data}if(f){c.head.trigger("expandedByHashChange",[f])}if(c.initOnly||c.expanded=="undefined"||!c.expanded){c.head.data("panel").tab.data("tabSettings").expanded=true;b.expandStarted(c);var d=(c.initOnly||(!e&&f))?"":c.expandSpeed;c.body.stop(false,true);if(c.slideAnim){c.body.slideDown(d,b.expandedFully(c))}else{c.body.show(d,b.expandedFully(c))}b.toggleButtons(c);if(c.initOnly&&c.expandedByHash){window.location.hash=window.location.hash}}else{if(c.expanded&&!f){}}},collapse:function(c){if(c.data!=undefined){if(typeof(c.stopPropagation)=="function"){c.stopPropagation()}c=c.data}if(c.initOnly||c.expanded=="undefined"||c.expanded==true){var d=(!c.initOnly||!c.expandedByHash);if(d){c.head.data("panel").tab.data("tabSettings").expanded=false;b.collapseStarted(c);var e=(c.initOnly||!c.body.is(":visible"))?"":c.collapseSpeed;c.body.stop(false,true);if(!c.initOnly&&c.slideAnim){c.body.slideUp(e,b.collapsedFully(c))}else{c.body.hide(e,b.collapsedFully(c))}b.toggleButtons(c)}else{b.expand(c,true)}}},hashInPanel:function(d,c,e){var g=window.location.hash;if(g){if(c==undefined){c=d.data("panel").body}if(g.indexOf(b.settings.tabHashPrefix)==1){g="#"+g.substr(b.settings.tabHashPrefix.length+1)}var f=c.add(d);var h=f.find(g).add(f.filter(g));if(h.length){return g}}return false},toggleButtons:function(e){if(e.buttonExpand||e.buttonCollapse){var i=document.activeElement;var g;var c;if(e.expanded){if(e.buttonExpand){g=e.buttonExpand;e.buttonExpand.hide()}if(e.buttonCollapse){c=e.buttonCollapse;e.buttonCollapse.show()}}else{if(e.buttonCollapse){g=e.buttonCollapse;e.buttonCollapse.hide()}if(e.buttonExpand){c=e.buttonExpand;e.buttonExpand.show()}}if(b.settings.moveButtonTitle){var d=e.head.data("panel").tab;if(g.length){d.attr("title",d.data("title"));g.attr("title",g.data("title"))}if(c.length){var d=e.head.data("panel").tab;var h=d.attr("title");if(!h){h=""}d.data("title",h);var f=c.attr("title");if(!f){f=""}c.data("title",f);if(f){d.attr("title",h+f)}c.attr("title","")}}if(g.length&&g[0]==i){c.focus()}else{if(!c){e.head.focus()}else{if(i==e.head.data("panel").tab[0]){b.setButtonImgFocus(e)}}}}},expandStarted:function(c){c.head.add(c.body).addClass("fs_expandStarted");if(!c.initOnly){c.wrapper.trigger("actionStarted",["expand",c.head])}a.fn.metools("updateVirtualBuffer")},expandedFully:function(c){c.body.find("."+b.settings.triggerShown).trigger("onshown");c.head.add(c.body).addClass("fs_expandedFully");if(!c.initOnly){c.wrapper.trigger("actionEnded",["expand",c.head])}},collapseStarted:function(c){c.head.add(c.body).removeClass("fs_expandedFully");if(!c.initOnly){c.wrapper.trigger("actionStarted",["collapse",c.head])}},collapsedFully:function(c){c.head.add(c.body).removeClass("fs_expandStarted");if(!c.initOnly){c.wrapper.trigger("actionEnded",["collapse",c.head])}a.fn.metools("updateVirtualBuffer")},mouseenter:function(e,d){var c=e.data.head.data("panel").tab;if(!d||c.data("tabSettings").mouseInside){c.addClass(b.settings.state.hover).data("tabSettings").mouseInside=true;b.setButtonImgHover(e.data)}e.stopPropagation()},mouseinside:function(c){c.data.head.data("panel").tab.data("tabSettings").mouseInside=true},mouseleave:function(e,d){var c=e.data.head.data("panel").tab;c.removeClass(b.settings.state.hover);var f=document.activeElement;if(c[0]!=f){b.resetButtonImg(c)}if(!d){c.data("tabSettings").mouseInside=false}},mouseenterInside:function(d){var c=d.data.head.data("panel").tab;c.addClass(b.settings.state.hoverInside);c.trigger("mouseleave",[true])},mouseleaveInside:function(d){var c=d.data.head.data("panel").tab;c.removeClass(b.settings.state.hoverInside);c.trigger("mouseenter",[true])},mouseover:function(c){},mouseout:function(c){},setButtonImgHover:function(d){var c=(d.expanded)?d.buttonCollapseSrcHover:d.buttonExpandSrcHover;if(c){var e=(d.expanded)?d.buttonCollapse:d.buttonExpand;e.find("img").attr("src",c)}},setButtonImgFocus:function(d){var c=(d.expanded)?d.buttonCollapseSrcFocus:d.buttonExpandSrcFocus;if(c){var e=(d.expanded)?d.buttonCollapse:d.buttonExpand;e.find("img").attr("src",c)}},resetButtonImg:function(c){var d,e;if(c.data("tabSettings").expanded){d=c.data("tabSettings").buttonCollapseSrc;e=c.data("tabSettings").buttonCollapse}else{d=c.data("tabSettings").buttonExpandSrc;e=c.data("tabSettings").buttonExpand}if(d&&!e.hasClass(b.settings.state.focus)){e.find("img").attr("src",d)}},focus:function(d){var c=d.data.head.data("panel").tab;c.addClass(b.settings.state.focus);b.setButtonImgFocus(c.data("tabSettings"))},focusButton:function(d){var c=a(this);c.addClass(b.settings.state.focus);b.setButtonImgFocus(d.data)},blur:function(d){var c=d.data.head.data("panel").tab;c.removeClass(b.settings.state.focus);if(!c.hasClass(b.settings.state.hover)){b.resetButtonImg(c)}},blurInside:function(c){b.blur(c)},blurButton:function(e){var c=a(this);var d=e.data.head.data("panel").tab;c.removeClass(b.settings.state.focus);if(!d.hasClass(b.settings.state.hover)){b.resetButtonImg(d)}},enableTab:function(c){c.removeClass(b.settings.state.disabled)},disableTab:function(c){c.addClass(b.settings.state.disabled)},stopPropagationForElementsInTab:function(e){var c=(e.type=="click"||e.type=="dblclick");if(!c){if(!e.ctrlKey&&!e.shiftKey&&!e.altKey){var d=(e.keyCode?e.keyCode:e.which);if(d==KEY_ENTER){c=true}}}if(c){e.stopPropagation()}}})})(jQuery);